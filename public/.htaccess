RewriteEngine On

# Wiki preview (must come before article rules)
RewriteRule ^wiki/preview/?$ /modules/wiki/preview.php [L,QSA]

# Template pages - must come before general namespace rule
# /wiki/Template:Title -> /modules/wiki/template.php?title=Template:Title
# /wiki/Template:Title%20with%20spaces -> /modules/wiki/template.php?title=Template:Title with spaces
RewriteRule ^wiki/Template:([a-zA-Z0-9\-_\s%20]+)/?$ /modules/wiki/template.php?title=Template:$1 [L,QSA,B]

# Wiki pretty URLs with namespace support
# /wiki/Namespace:Title -> /modules/wiki/article.php?title=Namespace:Title
RewriteRule ^wiki/([a-zA-Z0-9\-_]+):([a-zA-Z0-9\-_]+)/?$ /modules/wiki/article.php?title=$1:$2 [L,QSA]

# /wiki/article-name -> /modules/wiki/article.php?slug=article-name
RewriteRule ^wiki/([a-zA-Z0-9\-_]+)/?$ /modules/wiki/article.php?slug=$1 [L,QSA]

# /wiki/article-name/history -> /modules/wiki/history.php?slug=article-name
RewriteRule ^wiki/([a-zA-Z0-9\-_]+)/history/?$ /modules/wiki/history.php?slug=$1 [L,QSA]

# /wiki/article-name/talk -> /modules/wiki/talk.php?slug=article-name
RewriteRule ^wiki/([a-zA-Z0-9\-_]+)/talk/?$ /modules/wiki/talk.php?slug=$1 [L,QSA]

# /wiki/article-name/edit -> /pages/wiki/edit_article.php?slug=article-name
RewriteRule ^wiki/([a-zA-Z0-9\-_]+)/edit/?$ /pages/wiki/edit_article.php?slug=$1 [L,QSA]

# /wiki/Template:Title/edit -> /pages/wiki/edit_template.php?title=Template:Title
# /wiki/Template:Title%20with%20spaces/edit -> /pages/wiki/edit_template.php?title=Template:Title with spaces
RewriteRule ^wiki/Template:([a-zA-Z0-9\-_\s%20]+)/edit/?$ /pages/wiki/edit_template.php?title=Template:$1 [L,QSA,B]

# /wiki/Namespace:Title/edit -> /pages/wiki/edit_article.php?title=Namespace:Title
RewriteRule ^wiki/([a-zA-Z0-9\-_]+):([a-zA-Z0-9\-_]+)/edit/?$ /pages/wiki/edit_article.php?title=$1:$2 [L,QSA]

# Special pages
RewriteRule ^wiki/special/([a-zA-Z0-9\-_]+)/?$ /modules/wiki/special/$1.php [L,QSA]

# Category pages
RewriteRule ^wiki/category/([a-zA-Z0-9\-]+)/?$ /modules/wiki/category.php?slug=$1 [L,QSA]

# Default wiki index - redirect to Main_Page
RewriteRule ^wiki/?$ /wiki/Main_Page [R=301,L]

# Wiki management pages
RewriteRule ^wiki/upload/?$ /pages/wiki/upload_file.php [L,QSA]
RewriteRule ^wiki/manage/redirects/?$ /pages/wiki/manage_redirects.php [L,QSA]
RewriteRule ^wiki/manage/files/?$ /pages/wiki/manage_files.php [L,QSA]
RewriteRule ^wiki/manage/templates/?$ /pages/wiki/manage_templates.php [L,QSA]

# Maintenance page
RewriteRule ^maintenance/?$ /maintenance.php [L,QSA]

# Auth pages
RewriteRule ^login/?$ /pages/auth/login.php [L,QSA]
RewriteRule ^register/?$ /pages/auth/register.php [L,QSA]
RewriteRule ^logout/?$ /logout.php [L,QSA]

# User pages
RewriteRule ^dashboard/?$ /pages/user/dashboard.php [L,QSA]
RewriteRule ^settings/?$ /pages/user/settings.php [L,QSA]
RewriteRule ^profile/?$ /pages/user/profile.php [L,QSA]
RewriteRule ^user/([a-zA-Z0-9\-_]+)/?$ /pages/user/user_profile.php?username=$1 [L,QSA]

# Search pages
RewriteRule ^search/advanced/?$ /search/advanced.php [L,QSA]

# API endpoints
RewriteRule ^api/ajax/search_suggestions/?$ /api/ajax/search_suggestions.php [L,QSA]
RewriteRule ^api/ajax/upload_image/?$ /api/ajax/upload_image.php [L,QSA]
RewriteRule ^api/ajax/send_message/?$ /api/ajax/send_message.php [L,QSA]
RewriteRule ^api/ajax/get_messages/?$ /api/ajax/get_messages.php [L,QSA]

# Social pages
RewriteRule ^feed/?$ /pages/social/feed.php [L,QSA]
RewriteRule ^friends/?$ /pages/social/friends.php [L,QSA]
RewriteRule ^friends/requests/?$ /modules/friends/requests.php [L,QSA]
RewriteRule ^friends/suggestions/?$ /modules/friends/suggestions.php [L,QSA]
RewriteRule ^friends/lists/?$ /modules/friends/lists.php [L,QSA]
RewriteRule ^friends/all/?$ /modules/friends/all.php [L,QSA]
RewriteRule ^create_post/?$ /pages/social/create_post.php [L,QSA]
RewriteRule ^messages/?$ /pages/social/messages.php [L,QSA]
RewriteRule ^messages/sent/?$ /modules/messages/sent.php [L,QSA]
RewriteRule ^messages/compose/?$ /modules/messages/compose.php [L,QSA]
RewriteRule ^notifications/?$ /pages/notifications.php [L,QSA]

# Admin pages
RewriteRule ^admin/?$ /pages/admin/admin.php [L,QSA]
RewriteRule ^admin/analytics/?$ /pages/admin/analytics.php [L,QSA]
RewriteRule ^admin/manage_users/?$ /pages/admin/manage_users.php [L,QSA]
RewriteRule ^admin/system_settings/?$ /pages/admin/system_settings.php [L,QSA]
RewriteRule ^admin/content_moderation/?$ /pages/admin/content_moderation.php [L,QSA]
RewriteRule ^admin/maintenance/?$ /pages/admin/maintenance.php [L,QSA]
RewriteRule ^admin/manage_permissions/?$ /pages/admin/manage_permissions.php [L,QSA]
RewriteRule ^admin/manage_redirects/?$ /pages/admin/manage_redirects.php [L,QSA]
RewriteRule ^admin/manage_files/?$ /pages/admin/manage_files.php [L,QSA]
RewriteRule ^admin/manage_categories/?$ /pages/admin/manage_categories.php [L,QSA]
RewriteRule ^admin/create_article/?$ /pages/admin/create_article.php [L,QSA]
RewriteRule ^admin/edit_article/?$ /pages/admin/edit_article.php [L,QSA]
RewriteRule ^admin/edit_user/?$ /pages/admin/edit_user.php [L,QSA]

# Handle trailing slashes
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /$1 [R=301,L]
